<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // 현재 신청인원 불러오기
            $.get('https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec?totalParticipants=true', function(response) {
                $('#currentParticipants').text(`현재 총 ${response.total}명이 참가 신청중입니다 (${response.waiting}명은 대기접수 중입니다.)`);
                window.totalParticipants = response.total; // 전역 변수로 저장
            }, 'json');

            $('#signupForm').on('submit', function(event) {
                event.preventDefault();
                var formData = {
                    name: $('#name').val(),
                    tel: $('#tel').val(),
                    join: $('#join').val(),
                    joinbaby: $('#joinbaby').val(),
                    joinoption: $('#joinoption').val(),
                    etc: $('#etc').val()
                };

                $.post('https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec', formData, function(response) {
                    alert(response.message);
                }, 'json');
            });

            $('#searchButton').on('click', function() {
                var tel = $('#telInput').val();
                $.get('https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec', { tel: tel }, function(response) {
                    if (response.status === 'success') {
                        var data = response.data;
                        var formattedResult = `성명: ${data.name}\n참석인원: ${data.join}\n코스: ${data.joinoption}`;
                        $('#searchResult').text(formattedResult);

                        // 변경하기 버튼 및 셀렉트 박스 표시
                        $('#updateSection').show();
                        $('#currentTel').val(data.tel);  // 현재 전화번호 저장
                        $('#currentJoin').val(data.join); // 현재 참석인원 저장

                        // 참석인원 선택 옵션 업데이트
                        updateJoinOptions(parseInt(data.join));
                    } else {
                        alert(response.message);
                    }
                }, 'json');
            });

            $('#updateButton').on('click', function() {
                var tel = $('#currentTel').val();
                var newJoin = $('#newJoin').val();
                var currentJoin = $('#currentJoin').val();

                if (parseInt(newJoin) === parseInt(currentJoin)) {
                    alert('현재 신청된 인원과 같습니다. 다른 값을 선택해 주세요.');
                    return;
                }

                $.post('https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec', { tel: tel, join: newJoin }, function(response) {
                    alert(response.message);
                }, 'json');
            });

            function updateJoinOptions(currentJoin) {
                var totalParticipants = window.totalParticipants;
                var joinSelect = $('#newJoin');
                joinSelect.empty();

                for (var i = 0; i <= 5; i++) {
                    if (totalParticipants > 40 && i >= currentJoin) {
                        continue; // 40명을 초과한 경우 현재 신청인원보다 큰 값은 추가하지 않음
                    }
                    joinSelect.append(new Option(i + (i === 0 ? '(취소)' : '명'), i));
                }
            }
        });
    </script>
    <style>
        body {
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h5 class="mb-4">산악회 등산(트래킹) 신청하기</h5>
        <form id="signupForm" class="mb-5">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="name-label">이름:</span>
                </div>
                <input type="text" class="form-control" id="name" name="name" required aria-describedby="name-label">
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="tel-label">연락처:</span>
                </div>
                <input type="text" class="form-control" id="tel" name="tel" required aria-describedby="tel-label">
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="join-label">참석인원:</span>
                </div>
                <select id="join" name="join" class="form-select" required aria-describedby="join-label">
                    <option value="1">1명</option>
                    <option value="2">2명</option>
                    <option value="3">3명</option>
                    <option value="4">4명</option>
                    <option value="5">5명</option>
                </select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="joinbaby-label">비회원 인원:</span>
                </div>
                <select id="joinbaby" name="joinbaby" class="form-select" required aria-describedby="joinbaby-label">
                    <option value="0">없음</option>
                    <option value="1">1명</option>
                    <option value="2">2명</option>
                    <option value="3">3명</option>
                    <option value="4">4명</option>
                    <option value="5">5명</option>
                </select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="joinoption-label">코스 선택:</span>
                </div>
                <select id="joinoption" name="joinoption" class="form-select" required aria-describedby="joinoption-label">
                    <option value="A코스">A코스</option>
                    <option value="B코스">B코스</option>
                </select>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="etc-label">기타:</span>
                </div>
                <input type="text" class="form-control" id="etc" name="etc" aria-describedby="etc-label">
            </div>
            <button type="submit" class="btn btn-primary">제출</button>
        </form>
        <div id="currentParticipants" class="mb-4"></div>
        <hr>
        <h4 class="mb-4">신청내역 조회</h4>
        <div class="mb-3">
            <label for="telInput" class="form-label">연락처:</label>
            <input type="text" class="form-control" id="telInput" name="telInput">
        </div>
        <button id="searchButton" class="btn btn-primary mb-3">조회하기</button>
        <h6 id="searchResult"></h6>
        
        <div id="updateSection" style="display:none;">
            <h4 class="mb-4">참석인원 변경하기</h4>
            <input type="hidden" id="currentTel">
            <input type="hidden" id="currentJoin">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="newJoin-label">새 참석인원:</span>
                </div>
                <select id="newJoin" class="form-select" aria-describedby="newJoin-label">
                    <!-- 옵션은 JavaScript로 동적으로 추가됩니다. -->
                </select>
            </div>
            <button id="updateButton" class="btn btn-primary">변경하기</button>
        </div>
    </div>
</body>
</html>
