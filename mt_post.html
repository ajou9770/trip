<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
            rel="stylesheet">
            <title>ğŸ“¤ì‚°ì•…íšŒ ë“±ë°˜(íŠ¸ë˜í‚¹)ì‹ ì²­ì„œ</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function () {
                // í˜„ì¬ ì‹ ì²­ì¸ì› ë¶ˆëŸ¬ì˜¤ê¸°
                $.get(
                    'https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9' +
                            'CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec?totalParticipants=true',
                    function (response) {
                        $('#currentParticipants').text(
                            `ğŸ¤·â€â™‚ï¸í˜„ì¬ ì´ ${response.total}ëª…ì´ ì°¸ê°€ ì‹ ì²­ì¤‘ì…ë‹ˆë‹¤ \n(âš ${response.waiting}ëª…ì€ ì ‘ìˆ˜ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤.)`
                        );
                        window.totalParticipants = response.total; // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
                    },
                    'json'
                );

                // ì œì¶œí•˜ê¸°
                $('#signupForm').on('submit', function (event) {
                    event.preventDefault();

                    var formData = {
                        name: $('#name').val(),
                        tel: $('#tel').val(),
                        join: $('#join').val(),
                        joinbaby: $('#joinbaby').val(),
                        joinoption: $('#joinoption').val(),
                        etc: $('#etc').val()
                    };

                    var confirmationMessage = `ğŸ¤·â€â™€ï¸ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš” \n
        - ì„±  ëª…: ${formData.name}
        - ì—°ë½ì²˜: ${formData.tel}
        - ì°¸ì„ì¸ì›: ${formData.join}
        - ì˜ˆë¹„íšŒì›: ${formData.joinbaby}
        - ì„ íƒ ì½”ìŠ¤: ${formData.joinoption}\n`;

                    if (confirm(confirmationMessage + '\nì´ëŒ€ë¡œ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                        var $submitButton = $('#signupButton');
                        $submitButton
                            .prop('disabled', true)
                            .text('ğŸ“¤ì œì¶œì¤‘...');

                        $
                            .post(
                                'https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9' +
                                        'CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec',
                                formData,
                                function (response) {
                                    alert(response.message);
                                },
                                'json'
                            )
                            .always(function () {
                                // ì™„ë£Œ í›„ ë²„íŠ¼ ìƒíƒœ ë³µì›
                                $submitButton
                                    .prop('disabled', false)
                                    .text('ğŸ“¤ì œì¶œí•˜ê¸°');
                            });
                    }
                });

                // ì¡°íšŒí•˜ê¸°
                $('#searchButton').on('click', function () {
                    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                    var $searchButton = $('#searchButton');
                    $searchButton
                        .prop('disabled', true)
                        .text('ğŸ”ì¡°íšŒì¤‘...');

                    var tel = $('#telInput').val();

                    // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ (1ì´ˆ ë™ì•ˆ í˜ì´ì§€ë¥¼ ì•„ë˜ë¡œ ì´ë™)
                    $('html, body').animate({
                        scrollTop: $('#searchResult')
                            .offset()
                            .top
                    }, 1000); // 1000ms = 1ì´ˆ

                    $
                        .get(
                            'https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9' +
                                    'CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec',
                            {
                                tel: tel
                            },
                            function (response) {
                                if (response.status === 'success') {
                                    var data = response.data;
                                    var formattedResult = `â–¶ì„±ëª…: ${data.name} /\nì°¸ì„ì¸ì›: ${data.join}ëª… /\nì½”ìŠ¤: ${data.joinoption}`;
                                    $('#searchResult').text(formattedResult);

                                    // ë³€ê²½í•˜ê¸° ë²„íŠ¼ ë° ì…€ë ‰íŠ¸ ë°•ìŠ¤ í‘œì‹œ
                                    $('#updateSection').show();
                                    $('#currentTel').val(data.tel); // í˜„ì¬ ì „í™”ë²ˆí˜¸ ì €ì¥
                                    $('#currentJoin').val(data.join); // í˜„ì¬ ì°¸ì„ì¸ì› ì €ì¥

                                    // ì°¸ì„ì¸ì› ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
                                    updateJoinOptions(parseInt(data.join));
                                } else {
                                    alert(response.message);
                                }
                            },
                            'json'
                        )
                        .always(function () {
                            // ì™„ë£Œ í›„ ë²„íŠ¼ ìƒíƒœ ë³µì›
                            $searchButton
                                .prop('disabled', false)
                                .text('ğŸ”ì¡°íšŒí•˜ê¸°');
                        });
                });

                // ë³€ê²½í•˜ê¸°
                $('#updateButton').on('click', function () {
                    var $updateButton = $('#updateButton');
                    $updateButton
                        .prop('disabled', true)
                        .text('ğŸ”ë³€ê²½(ì·¨ì†Œ) ì²˜ë¦¬ì¤‘...');

                    var tel = $('#currentTel').val();
                    var newJoin = $('#newJoin').val();
                    var currentJoin = $('#currentJoin').val();

                    if (parseInt(newJoin) === parseInt(currentJoin)) {
                        alert('í˜„ì¬ ì‹ ì²­ëœ ì¸ì›ê³¼ ê°™ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê°’ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                        $updateButton
                            .prop('disabled', false)
                            .text('ğŸ”ë³€ê²½í•˜ê¸°');
                        return;
                    }

                    // ì·¨ì†Œ ì—¬ë¶€ í™•ì¸
                    if (parseInt(newJoin) === 0) {
                        if (!confirm('ğŸ¤·ì°¸ì„ì„ ì·¨ì†Œ í•˜ëŠ”ê²ƒì´ ë§ë‚˜ìš”?\n')) {
                            $updateButton
                                .prop('disabled', false)
                                .text('ğŸ”ë³€ê²½í•˜ê¸°');
                            return;
                        }
                    }

                    var confirmationMessage = `ğŸ¤·â€â™€ï¸ë³€ê²½ì‹ ì²­ë‚´ìš©í™•ì¸:\n
  - í˜„ì¬ ì‹ ì²­ ì¸ì›: ${currentJoin}ëª…
  - ë³€ê²½ í›„ ì¸ì›: ${newJoin}ëª…\n`;

                    if (confirm(confirmationMessage + '\nì´ëŒ€ë¡œ ë³€ê²½(ì·¨ì†Œ) í• ê¹Œìš”?\n')) {
                        $
                            .post(
                                'https://script.google.com/macros/s/AKfycbxHpu_I2T2M8JLxHgRLSqDFzRIogTx-x4OcLf9' +
                                        'CxjziJQb5_vBFp9TCStU2JpKca_m4Iw/exec',
                                {
                                    tel: tel,
                                    join: newJoin
                                },
                                function (response) {
                                    alert(response.message);
                                },
                                'json'
                            )
                            .always(function () {
                                // ì™„ë£Œ í›„ ë²„íŠ¼ ìƒíƒœ ë³µì›
                                $updateButton
                                    .prop('disabled', false)
                                    .text('ğŸ”ë³€ê²½í•˜ê¸°');
                            });
                    } else {
                        // ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ì„ íƒí•œ ê²½ìš°
                        $updateButton
                            .prop('disabled', false)
                            .text('ğŸ”ë³€ê²½í•˜ê¸°');
                    }
                });

                function updateJoinOptions(currentJoin) {
                    var totalParticipants = window.totalParticipants;
                    var joinSelect = $('#newJoin');
                    joinSelect.empty();

                    for (var i = 0; i <= 5; i++) {
                        if (totalParticipants > 40 && i >= currentJoin) {
                            /* alert('âš ì‹ ì²­ì¸ì›ì´ 40ëª…ì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš° í˜„ì¬ë³´ë‹¤ ì ê²Œë§Œ ë³€ê²½í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤'); */
                            continue; // 40ëª…ì„ ì´ˆê³¼í•œ ê²½ìš° í˜„ì¬ ì‹ ì²­ì¸ì›ë³´ë‹¤ í° ê°’ì€ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                        }
                        joinSelect.append(new Option(i + (
                            i === 0
                                ? '(ì·¨ì†Œ)'
                                : 'ëª…'
                        ), i));
                    }
                }
            });
        </script>
        <style>
            body {
                margin: 20px;
            }
            #searchResult {
                font-weight: 600;
                font-size: large;
                color: coral;
            }
            #currentParticipants {
                font-weight: 600;
                font-size: large;
                color: crimson;
            }
            .input-group-text {
                width: 130px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h5 class="mb-4">ì‚°ì•…íšŒ ë“±ì‚°(íŠ¸ë˜í‚¹) ì‹ ì²­í•˜ê¸°</h5>
            <form id="signupForm" class="mb-5">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="name-label">ì´ë¦„</span>
                    </div>
                    <input
                        type="text"
                        class="form-control"
                        id="name"
                        name="name"
                        required="required"
                        aria-describedby="name-label">
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="tel-label">ì—°ë½ì²˜</span>
                    </div>
                    <input
                        type="number"
                        class="form-control"
                        id="tel"
                        name="tel"
                        placeholder="ìˆ«ìë§Œ ì…ë ¥"
                        required="required"
                        aria-describedby="tel-label">
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="join-label">ì°¸ì„ì¸ì›</span>
                    </div>
                    <select
                        id="join"
                        name="join"
                        class="form-select"
                        required="required"
                        aria-describedby="join-label">
                        <option value="1">1ëª…</option>
                        <option value="2">2ëª…</option>
                        <option value="3">3ëª…</option>
                        <option value="4">4ëª…</option>
                        <option value="5">5ëª…</option>
                    </select>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="joinbaby-label">ì˜ˆë¹„íšŒì› ì¸ì›</span>
                    </div>
                    <select
                        id="joinbaby"
                        name="joinbaby"
                        class="form-select"
                        required="required"
                        aria-describedby="joinbaby-label">
                        <option value="0">ì—†ìŒ</option>
                        <option value="1">1ëª…</option>
                        <option value="2">2ëª…</option>
                        <option value="3">3ëª…</option>
                        <option value="4">4ëª…</option>
                        <option value="5">5ëª…</option>
                    </select>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="joinoption-label">ì½”ìŠ¤ëŠ”?</span>
                    </div>
                    <select
                        id="joinoption"
                        name="joinoption"
                        class="form-select"
                        required="required"
                        aria-describedby="joinoption-label">
                        <option value="Aì½”ìŠ¤">Aì½”ìŠ¤</option>
                        <option value="Bì½”ìŠ¤">Bì½”ìŠ¤</option>
                    </select>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="etc-label">ğŸ’¬ê¸°íƒ€ ì½”ë©˜íŠ¸</span>
                    </div>
                    <input
                        type="text"
                        class="form-control"
                        id="etc"
                        name="etc"
                        aria-describedby="etc-label">
                </div>
                <button type="submit" id="signupButton" class="btn btn-primary btn-block">ğŸ“¤ì œì¶œí•˜ê¸°</button>
            </form>
            <div id="currentParticipants" class="mb-4"></div>
            <hr>
            <h4 class="mb-4">ğŸ”ì‹ ì²­ë‚´ì—­ ì¡°íšŒ ë° ë³€ê²½(ì·¨ì†Œ)í•˜ê¸°</h4>
            <div class="mb-3">
                <label for="telInput" class="form-label">ğŸ¤·â€â™‚ï¸ì—°ë½ì²˜ ì…ë ¥ í›„ ì¡°íšŒí•˜ì„¸ìš”</label>
                <input
                    type="number"
                    class="form-control"
                    id="telInput"
                    placeholder="ìˆ«ìë§Œ ì…ë ¥"
                    name="telInput">
            </div>
            <button id="searchButton" class="btn btn-info mb-3">ğŸ”ì¡°íšŒí•˜ê¸°</button>
            <h5 id="searchResult"></h5>
            <br>
            <div id="updateSection" style="display:none;">
                <h4 class="mb-4">ğŸ”ì°¸ì„ì¸ì› ë³€ê²½(ì·¨ì†Œ)í•˜ê¸°</h4>
                <input type="hidden" id="currentTel">
                <input type="hidden" id="currentJoin">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="newJoin-label">ë³€ê²½í•  ì°¸ì„ì¸ì›:</span>
                    </div>
                    <select id="newJoin" class="form-select" aria-describedby="newJoin-label">
                        <!-- ì˜µì…˜ì€ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    </select>
                </div>
                <button id="updateButton" class="btn btn-danger">ğŸ”ë³€ê²½í•˜ê¸°</button>
            </div>
        </div>
    </body>
</html>